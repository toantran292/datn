// Prisma Schema for PM Service
// Database: PostgreSQL 16

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SprintStatus {
  FUTURE
  ACTIVE
  CLOSED
}

model Project {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.VarChar(255)
  identifier      String   @unique @db.VarChar(50)
  name            String   @db.VarChar(255)
  projectLead     String?  @map("project_lead") @db.Uuid
  defaultAssignee String?  @map("default_assignee") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  sprints       Sprint[]
  issues        Issue[]
  issueStatuses IssueStatus[]
  comments      IssueComment[]
  activities    IssueActivity[]

  @@map("project")
}

model Sprint {
  id                  String       @id @default(uuid()) @db.Uuid
  projectId           String       @map("project_id") @db.Uuid
  name                String       @db.VarChar(255)
  status              SprintStatus @default(FUTURE)
  goal                String?      @db.Text
  startDate           DateTime?    @map("start_date") @db.Date
  endDate             DateTime?    @map("end_date") @db.Date
  // Snapshot metrics taken when sprint starts
  initialIssueCount   Int?         @map("initial_issue_count")
  initialStoryPoints  Decimal?     @map("initial_story_points") @db.Decimal(10, 2)
  startedAt           DateTime?    @map("started_at") @db.Timestamptz
  // Completion metrics
  completedAt         DateTime?    @map("completed_at") @db.Timestamptz
  completedIssueCount Int?         @map("completed_issue_count")
  velocity            Decimal?     @db.Decimal(10, 2)
  createdAt           DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@map("sprint")
}

model IssueStatus {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  color       String   @db.VarChar(7) // Hex color like #FF0000
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@index([projectId])
  @@unique([projectId, order], name: "unique_project_status_order")
  @@map("issue_status")
}

model Issue {
  id              String   @id @default(uuid()) @db.Uuid
  projectId       String   @map("project_id") @db.Uuid
  sprintId        String?  @map("sprint_id") @db.Uuid
  parentId        String?  @map("parent_id") @db.Uuid
  statusId        String   @map("status_id") @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  descriptionHtml String?  @map("description_html") @db.Text
  priority        String   @db.VarChar(32)
  type            String   @db.VarChar(32)
  point           Decimal? @db.Decimal(5, 2)
  sequenceId      Int      @map("sequence_id")
  sortOrder       Decimal  @map("sort_order") @db.Decimal(20, 10)
  startDate       DateTime? @map("start_date") @db.Date
  targetDate      DateTime? @map("target_date") @db.Date
  assigneesJson   Json     @default("[]") @map("assignees_json") @db.JsonB
  createdBy       String?  @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project      Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint       Sprint?        @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  status       IssueStatus    @relation(fields: [statusId], references: [id], onDelete: Restrict)
  parent       Issue?         @relation("IssueHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  subIssues    Issue[]        @relation("IssueHierarchy")
  comments     IssueComment[]
  activities   IssueActivity[]

  @@index([projectId])
  @@index([sprintId])
  @@index([statusId])
  @@index([parentId])
  @@index([createdBy])
  @@unique([projectId, sequenceId], name: "unique_project_sequence_id")
  @@map("issue")
}

model IssueComment {
  id          String   @id @default(uuid()) @db.Uuid
  issueId     String   @map("issue_id") @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  comment     String?  @db.Text
  commentHtml String?  @map("comment_html") @db.Text
  createdBy   String   @map("created_by") @db.Uuid // User ID
  updatedBy   String?  @map("updated_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  issue   Issue   @relation(fields: [issueId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([projectId])
  @@index([createdBy])
  @@map("issue_comment")
}

model IssueActivity {
  id           String   @id @default(uuid()) @db.Uuid
  issueId      String   @map("issue_id") @db.Uuid
  projectId    String   @map("project_id") @db.Uuid
  field        String   @db.VarChar(100) // Field that changed: "name", "state", "priority", "assignee", etc.
  oldValue     String?  @map("old_value") @db.Text
  newValue     String?  @map("new_value") @db.Text
  oldIdentifier String? @map("old_identifier") @db.VarChar(255) // For display (e.g., status name, user name)
  newIdentifier String? @map("new_identifier") @db.VarChar(255)
  actorId      String   @map("actor_id") @db.Uuid // User who made the change
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  issue   Issue   @relation(fields: [issueId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([projectId])
  @@index([actorId])
  @@index([createdAt])
  @@map("issue_activity")
}
