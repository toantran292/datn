events {}

http {
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream auth_svc { server auth:40900; }
  upstream bff      { server bff:40800; }
  upstream identity { server identity:40000; }
  # upstream chat_ws  { server chat-api:40501; }
  # upstream meet_ws  { server meet-signal:40601; }

  server {
    listen 8080;
    server_name _;

    # ---------- Public: Identity (no auth_request) ----------
    location = /auth/register { proxy_pass http://identity; }
    location = /auth/token    { proxy_pass http://identity; }
    location = /.well-known/jwks.json            { proxy_pass http://identity; }
    location = /.well-known/openid-configuration { proxy_pass http://identity; }

    # -------- Create first org (no slug path) --------
    # Match both '/orgs' and '/orgs/'
    location ~* ^/orgs/?$ {
      proxy_set_header X-User-ID "";
      proxy_set_header X-Org-ID  "";
      proxy_set_header X-Org-Slug "";
      proxy_set_header X-Context-Signature "";
      proxy_set_header X-Context-Timestamp "";

      set $org_slug "";

      auth_request /_authz;
      auth_request_set $x_user_id $upstream_http_x_user_id;
      auth_request_set $x_org_id  $upstream_http_x_org_id;
      auth_request_set $x_orgslug $upstream_http_x_org_slug;
      auth_request_set $x_ts      $upstream_http_x_context_timestamp;
      auth_request_set $x_sig     $upstream_http_x_context_signature;

      proxy_set_header X-User-ID           $x_user_id;
      proxy_set_header X-Org-ID            $x_org_id;
      proxy_set_header X-Org-Slug          $x_orgslug;
      proxy_set_header X-Context-Timestamp $x_ts;
      proxy_set_header X-Context-Signature $x_sig;

      proxy_pass http://identity;
    }

    # ---------- Tenant-protected: /o/{slug}/auth/me ----------
    location ~ ^/o/([^/]+)/auth/me$ {
      set $org_slug $1;

      # strip forged headers
      proxy_set_header X-User-ID "";
      proxy_set_header X-Org-ID  "";
      proxy_set_header X-Org-Slug "";
      proxy_set_header X-Context-Signature "";
      proxy_set_header X-Context-Timestamp "";

      # auth_request to Auth Service
      auth_request /_authz;
      auth_request_set $x_user_id $upstream_http_x_user_id;
      auth_request_set $x_org_id  $upstream_http_x_org_id;
      auth_request_set $x_orgslug $upstream_http_x_org_slug;
      auth_request_set $x_ts      $upstream_http_x_context_timestamp;
      auth_request_set $x_sig     $upstream_http_x_context_signature;

      # inject headers
      proxy_set_header X-User-ID           $x_user_id;
      proxy_set_header X-Org-ID            $x_org_id;
      proxy_set_header X-Org-Slug          $x_orgslug;
      proxy_set_header X-Context-Timestamp $x_ts;
      proxy_set_header X-Context-Signature $x_sig;

      # Surface 401/403 from auth_request (do NOT forward to Identity)
      proxy_intercept_errors on;
      error_page 401 = @auth_unauth;
      error_page 403 = @auth_forbidden;

      # forward to Identity's /auth/me (subpath)
      rewrite ^/o/[^/]+/(.*)$ /$1 break;
      proxy_pass http://identity;
    }

    # ---------- Tenant-protected: /o/{slug}/api/* â†’ BFF ----------
    location ~ ^/o/([^/]+)/api/(.*)$ {
      set $org_slug $1;
      set $subpath /api/$2;

      proxy_set_header X-User-ID "";
      proxy_set_header X-Org-ID  "";
      proxy_set_header X-Org-Slug "";
      proxy_set_header X-Context-Signature "";
      proxy_set_header X-Context-Timestamp "";

      auth_request /_authz;
      auth_request_set $x_user_id $upstream_http_x_user_id;
      auth_request_set $x_org_id  $upstream_http_x_org_id;
      auth_request_set $x_orgslug $upstream_http_x_org_slug;
      auth_request_set $x_ts      $upstream_http_x_context_timestamp;
      auth_request_set $x_sig     $upstream_http_x_context_signature;

      proxy_set_header X-User-ID           $x_user_id;
      proxy_set_header X-Org-ID            $x_org_id;
      proxy_set_header X-Org-Slug          $x_orgslug;
      proxy_set_header X-Context-Timestamp $x_ts;
      proxy_set_header X-Context-Signature $x_sig;

      proxy_intercept_errors on;
      error_page 401 = @auth_unauth;
      error_page 403 = @auth_forbidden;

      proxy_pass http://bff/api/$2;
    }

    # ---------- Auth subrequest ----------
    location = /_authz {
      internal;
      proxy_pass              http://auth_svc/authorize;
      proxy_pass_request_body off;
      proxy_set_header        Authorization $http_authorization;
      proxy_set_header        X-Org-Slug    $org_slug;   # pass captured slug
      proxy_method            POST;
    }

    # ---------- Optional: WS with slug ----------
    # location ~ ^/o/([^/]+)/chat/(.*)$ {
    #   proxy_http_version 1.1;
    #   proxy_set_header Upgrade $http_upgrade;
    #   proxy_set_header Connection $connection_upgrade;
    #   proxy_pass http://chat_ws;
    # }
    # location ~ ^/o/([^/]+)/meet/(.*)$ {
    #   proxy_http_version 1.1;
    #   proxy_set_header Upgrade $http_upgrade;
    #   proxy_set_header Connection $connection_upgrade;
    #   proxy_pass http://meet_ws;
    # }

    # ---------- Error handlers for auth_request ----------
    location @auth_unauth    { return 401; }
    location @auth_forbidden { return 403; }
  }
}
