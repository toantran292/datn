# services/edge/nginx.conf
worker_processes auto;
events { worker_connections 4096; }

http {
  lua_shared_dict authz_cache 100m;
  resolver 1.1.1.1 ipv6=off;

  server {
    listen 80;
    server_name api.unifiedteamspace.com;

    # Upstreams
    set $pm_api  http://pm-api:3000;
    set $meet_api http://meet-api:3000;
    set $chat_api http://chat-api:3000;

    location ~ ^/(pm|meet|chat) {
      access_by_lua_block {
        local http  = require "resty.http"
        local cjson = require "cjson.safe"
        local hmac  = require "resty.openssl.hmac"
        local at = ngx.var.cookie_uts_at
        if not at or at == "" then return ngx.exit(401) end

        local org  = ngx.req.get_headers()["X-Requested-Org-Id"]
        local proj = ngx.req.get_headers()["X-Requested-Project-Id"]
        local key  = table.concat({"az:", at, ":", org or "-", ":", proj or "-", ":", ngx.req.get_method(), ":", ngx.var.uri})

        local cached = ngx.shared.authz_cache:get(key)
        local dec = cached and cjson.decode(cached)
        if not dec then
          local cli = http.new(); cli:set_timeout(1000)
          local res = cli:request_uri("http://identity:40000/authz/check", {
            method="GET",
            query = {
              method = ngx.req.get_method(),
              path = ngx.var.uri,
              org_id = org,
              project_id = proj
            },
            headers = { ["Authorization"]="Bearer "..at }
          })
          if not res or res.status ~= 200 then return ngx.exit(403) end
          dec = cjson.decode(res.body)
          if not dec or not dec.allow then return ngx.exit(403) end
          ngx.shared.authz_cache:set(key, res.body, dec.ttl or 60)
        end

        ngx.req.set_header("X-User-ID", dec.user_id)
        ngx.req.set_header("X-Org-ID", dec.org_id or "")
        ngx.req.set_header("X-Project-ID", dec.project_id or "")
        ngx.req.set_header("X-Roles", table.concat(dec.roles or {}, ","))
        ngx.req.set_header("X-Permissions", table.concat(dec.permissions or {}, ","))

        local ts = tostring(os.time())
        local signer = hmac.new(os.getenv("EDGE_HMAC_SECRET") or "change-me", "sha256")
        signer:update((dec.user_id or "").."|"..(dec.org_id or "").."|"..(dec.project_id or "").."|"..ts)
        ngx.req.set_header("X-Auth-Timestamp", ts)
        ngx.req.set_header("X-Auth-Signature", "v1 "..ngx.encode_base64(signer:final(true)))
      }

      # route tới đúng upstream
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      if ($request_uri ~* "^/pm")   { proxy_pass $pm_api;   break; }
      if ($request_uri ~* "^/meet") { proxy_pass $meet_api; break; }
      if ($request_uri ~* "^/chat") { proxy_pass $chat_api; break; }
      return 404;
    }
  }
}